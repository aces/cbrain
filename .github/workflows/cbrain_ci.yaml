
# GitHub Actions Continuous Integration
#
# This runs rspec and other test suites for the CBRAIN platform codebase
#
# Pierre Rioux, January 2021

name: cbrain_ci
on:   [ push, pull_request ]
jobs:
  run-tests:
    name: Continuous Integration Tests
    runs-on: ubuntu-20.04
    env:
      RAILS_ENV: test

    ###########################################################
    services:
      mariadb:
        image: mariadb/server
        env: # the docker container's autosetup use MYSQL_ variables
          MYSQL_ROOT_PASSWORD: that_is_nothing
          MYSQL_DATABASE:      cbrain_test
          MYSQL_USER:          cbrain_user
          MYSQL_PASSWORD:      fake_pw_of_course
        ports:
        - 3306:3306

    ###########################################################
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: 2.6.6
      - uses: actions/cache@v1
        with:
          path: gem-cache
          key: ${{ runner.os }}-gems-${{ hashFiles('*/Gemfile') }}

      ###########################################################
      - name: Setup BrainPortal And Bourreau Names
        run: |
          bash .github/workflows/scripts/make_cbrain_app_name_rb.sh > BrainPortal/config/initializers/config_portal.rb

      ###########################################################
      - name: Configure Database Connection
        env: # keep in sync with the values in the 'services' section above
          MARIADB_ROOT_PASSWORD: that_is_nothing
          MARIADB_DATABASE:      cbrain_test
          MARIADB_USER:          cbrain_user
          MARIADB_PASSWORD:      fake_pw_of_course
          MARIADB_HOST:          127.0.0.1
          MARIADB_PORT:          3306
        run: |
          bash .github/workflows/scripts/make_database_yml.sh > BrainPortal/config/database.yml || exit 2
          sleep 10 # darn...
          mysql --host ${MARIADB_HOST} --port ${MARIADB_PORT} -u ${MARIADB_USER} -p${MARIADB_PASSWORD} -D ${MARIADB_DATABASE} -e "SHOW TABLES;"

      ###########################################################
      - name: Prepare Ruby Gems
        run: |
          cd BrainPortal                   || exit 2
          bundle config path ../gem-cache  || exit 3
          bundle install                   || exit 4
          cd ../Bourreau                   || exit 2
          bundle config path ../gem-cache  || exit 3
          bundle install                   || exit 4

      ###########################################################
      - name: Configure Plugins
        working-directory: BrainPortal
        run: |
          bundle exec rake cbrain:plugins:install:plugins

      ###########################################################
      - name: Setup Database
        working-directory: BrainPortal
        run: |
          bundle exec rake db:create      || exit 3
          bundle exec rake db:schema:load || exit 4

      ###########################################################
      - name: Seed Database
        working-directory: BrainPortal
        run: |
          bundle exec rake db:seed

      ###########################################################
      - name: Seed Boureau Test Data
        working-directory: BrainPortal
        run: |
          bundle exec rake db:seed:test:bourreau

      ###########################################################
      - name: Perform Sanity Checks
        working-directory: BrainPortal
        run: |
          bundle exec rake db:sanity:check

      ###########################################################
      - name: Portal Tests
        working-directory: BrainPortal
        run: |
          bundle exec rspec spec

      ###########################################################
      - name: Bourreaux Tests
        working-directory: Bourreau
        run: |
          bundle exec rspec spec/boutiques

      ###########################################################
      - name: Curl API tests
        working-directory: BrainPortal
        run: |
          bundle exec rake "db:seed:test:api"      || exit 2
          bundle exec rails server puma -p 3000 -d || exit 3
          cd test_api
          sleep 5
          perl curl_req_tester.pl -h localhost -p 3000 -s http -v${CBRAIN_CURL_TEST_VERBOSE_LEVEL:-1} -R
          status=$?
          kill $(cat ../tmp/pids/server.pid)
          exit $status

      ###########################################################
      - name: Ruby CodeGen API tests
        working-directory: BrainPortal
        run: |
          bundle exec rake "db:seed:test:api"      || exit 2
          bundle exec rails server puma -p 3000 -d || exit 3
          cd test_api
          sleep 5
          bundle exec rake "cbrain:test:api:client" -v "${CBRAIN_GEM_TEST_VERBOSE_LEVEL:-1}"
          status=$?
          kill $(cat ../tmp/pids/server.pid)
          exit $status

      ###########################################################
      - name: Notify Slack
        continue-on-error: true
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: cbrain_travis
          SLACK_COLOR: ${{ job.status == 'success' && 'green' || job.status == 'cancelled' && 'grey' || 'red' }}
          SLACK_TITLE: GitHub Action
          SLACK_MESSAGE: 'Integration test successful'
          SLACK_USERNAME: prioux
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}


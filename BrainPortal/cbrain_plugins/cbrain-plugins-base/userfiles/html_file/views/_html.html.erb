<%
#
# CBRAIN Project
#
# Copyright (C) 2008-2025
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
%>

This HTML document is not part of CBRAIN. <em> You should <strong>not</strong> view or
  interact with it unless you fully trust it. </em> (Forms and external links are disabled.)
<br>

<% if params[:new_tab].blank?
     # show only on userfile page %>
  <%= link_to(
        "Open in a separate tab",
        display_userfile_url(@userfile,
                             :viewer => :html,
                             :content_viewer => "on",
                             :file_name => @userfile.name,
                             :viewer_userfile_class => "HtmlFile",
                             :new_tab => "yes"
        ),
        :target => "_blank"
      ) %>
<% end %>
<br>

<%# -- for other user's files ask confirmation, unless user of files is marked as trusted %>
<% hide_frame = params[:new_tab].blank? && current_user.id != @userfile.user_id %>
<% hide_frame &&= !cbrain_session[:trust_user_files]&.include?(@userfile.user_id) %>
<% hide_frame &&= !cbrain_session[:trust_userfiles]&.include?(@userfile.id) %>
<% if hide_frame %>
  <div class="trust-file-btn">

    <%= link_to "I trust all #{@userfile.user.login}'s  files,",
                trust_creator_userfile_path(@userfile),
                method: :post,
                remote: true
    %>
    show them without warnings during this session
  </div>
  <div class="trust-file-btn">
    <%= link_to "Show just this userfile",
                trust_userfile_path(@userfile),
                method: :post,
                remote: true
    %>
  </div>
<% end %>

<br>

<div class="iframe-container" id="iframe-container"
     <% if hide_frame %>
        hidden
     <% end %>
     >
  <iframe sandbox="allow-scripts allow-same-origin"
          data-frame-url="<%= stream_userfile_path(@userfile, :disposition => 'inline') %>"
          <% unless hide_frame %>
            src="<%= stream_userfile_path(@userfile, :disposition => 'inline') %>"
          <% end %>
          class="full-frame html-viewer"
          class="full-frame html-viewer"
          <% if params[:new_tab].present?
               # workaround to wide frame in a new tab %>
            style="height: 100%; width: 100%;"
          <% end %>
          >
    HTML Viewer
  </iframe>
</div>

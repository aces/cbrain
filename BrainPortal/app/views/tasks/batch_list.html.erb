
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.  
#
-%>

<% num_tasks        = @tasks.size %>
<% first_task       = @tasks.first %>
<% batch_id         = first_task ? first_task.batch_id : nil %>
<% batch_id_or_zero = batch_id || 0 %>
<% batch_scope      = CbrainTask.real_tasks.where(:batch_id => batch_id) %>

<% if @tasks.empty? %>
  <tr><td colspan="<%= current_project ? "10" : "11" %>">This batch of tasks has disappeared.</td></tr>
<% else %>
  <tr class="batch_job_header row_highlight">
    <td>
      <%= select_all_checkbox "task_checkbox_#{batch_id_or_zero}", :id  => "task_header_checkbox_#{batch_id_or_zero}", :class  => "task_checkbox" %>
    </td>
    <td class="left">
      <% if batch_id %>
        <%= show_hide_toggle  "#{first_task.pretty_name} (Batch)", ".batch_listing_#{batch_id_or_zero}" %>
      <% else %>
        <%= show_hide_toggle  "(Various)", ".batch_listing_#{batch_id_or_zero}" %>
      <% end %>
    </td>
    <td><%= overlay_description(first_task.description, :header_width => 35) if false && batch_id %></td>
    <td><%= link_to_user_if_accessible(first_task.user) if false && batch_id %></td>
    <% unless current_project %>
      <td><%= link_to_group_if_accessible(first_task.group) if false && batch_id %></td>
    <% end %>
    <td><%= link_to_bourreau_if_accessible(first_task.bourreau) if false && batch_id %></td>
    <td colspan="2" class="left_align">
      <% stat_cnt = @tasks.to_a.hashed_partitions { |t| t.status =~ /Fail/ ? 'Failed' : t.status } %>
      <% if stat_cnt.size > 1 %>
        <% if batch_id %>
          <%= pluralize(num_tasks, "task") %> :
        <% else %>
          <%= pluralize(num_tasks, "old task") %> :
        <% end %>
      <% end %>
      <% report   = stat_cnt.keys.sort { |s1,s2| cmp_status_order(s1,s2) }.map { |s| "#{stat_cnt[s].size} x #{colored_status(s)}" }.join(", ") %>
      <%= report.html_safe %>
    </td>
    <td>
      <%= colored_pretty_size(batch_scope.sum(:cluster_workdir_size)) %>
    </td>
    <td>
      <% if batch_id %>
        <%= to_localtime(first_task.launch_time, :datetime) %>
      <% end %>
    </td>
    <td>
      <% if batch_id %>
        <%= to_localtime(batch_scope.order(:updated_at.desc).first.updated_at, :datetime) %>
      <% end %>
    </td>
  </tr>
<% end %>

<% for task in @tasks %>
  <%= render :partial => 'task_table_row',
             :locals  => { :task             => task,
                           :task_available   => @bourreau_status[task.bourreau.id] ? true : false,
                           :is_child         => true,
                         }
  %>
<% end %>


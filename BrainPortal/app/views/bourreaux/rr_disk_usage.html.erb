
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.  
#
-%>

<!-- *********************************** -->
<!-- Disk usage summary       -->
<!-- For Data Provider Caches -->
<!-- *********************************** -->

<% title "Disk Usage Caches" %>

<h2>Disk Usage Statistics for Server's Data Provider Caches</h2>

<span class="display_cell">  
  <%= form_tag(:action  => :cleanup_caches) do %>
    <P>

    <table>
  
      <% if @report_rrs.size > 0 %>
        <tr>
          <th class="blank"></th>
          <% @report_rrs.each do |rr| %>
            <th>
              <% if rr.is_a?(String) %>
                <%= rr.capitalize %>
              <% else %>
                <%= link_to_bourreau_if_accessible(rr, current_user) %>
                <br/>
                <small><%= rr.is_a?(Bourreau) ? "(Execution)" : "(Portal)" %></small>
              <% end %>
            </th>
          <% end %>
        </tr>
      <% end %>
      
      <% @report_users_all.each do |user| %>
        <tr> 
          <td>
            <% if user.is_a?(User) %>
              <%= link_to_user_with_tooltip(user) %>
              <% # All servers checkbox -%>
              <BR><%= select_all_checkbox("clean_cache_users_#{user.id}") %>
            <% else %>
              <% # Usually this is the keyword 'TOTAL' -%>
              <%= user.capitalize %>
            <% end %>
          </td>
           
          <% @report_rrs.each do |rr| %>
           
            <% cell = @report_stats[user] ? @report_stats[user][rr] : nil %>
    
            <% if ! cell %>
              <td></td>
              <% next %>
            <% end %>
    
            <td>
              <%= disk_space_info_display(cell[:size] || 0) do %>
                <%= pretty_size(cell[:size]) %></br>
                <%= (pluralize(cell[:num_entries],"entry") + " / " + pluralize(cell[:num_files],"file")).gsub(/ / ,"&nbsp;").html_safe %>
                <% if cell[:unknowns] > 0 %>
                  </br><%= pluralize(cell[:unknowns],"unknown").gsub(/ / ,"&nbsp;").html_safe %>
                <% end %>
                    
                <% if @report_rrs.include?(rr) && @report_users.include?(user) %>
                  </br><%= check_box_tag('clean_cache[]', "#{user.id},#{rr.id}", false, :class => "clean_cache_users_#{user.id} clean_cache_rrs_#{rr.id}" ) %>
                <% elsif @report_users_all[-1] == user && ! @report_users.include?(user) %>
                  <br/>
                  <% if user.is_a?(String) %>
                     <strong>All on <%= rr.name %>: </strong>
                  <% end %>
                  <%= select_all_checkbox( "clean_cache_rrs_#{rr.id}" ) %>
                <% end %>  
              
              <% end %>
            </td>
    
          <% end %>    <%# end column iteration %>
        </tr>
      <% end %>    <%# end row iteration %>
  
      <tr>
        <% if @report_rrs.size == 0 && @report_users.size == 0 %>
          <th>(There are no entries in this report)</th>
        <% else %>
          <th colspan="<%= 1+@report_rrs.size %>">
            <%= submit_tag 'Cleanup Selected Caches' %>
          </th>
        <% end %>
      </tr>
    </table>
    
    <p/><%= disk_usage_legend %>
    
    <%= hidden_field_tag "cleanup_older",    @cache_older %>
    <%= hidden_field_tag "cleanup_younger",  @cache_younger %>
    
    <% end %> <!-- form -->
  </span>

<P>

<!-- *********************************** -->
<!-- Refresh form -->
<!-- *********************************** -->

<%= form_tag({ :action  => :rr_disk_usage }, :method => :get) do %>
  Files reported in the <em>Caches</em> report were last accessed:
  <div class="display_table">
  <% params[:date_range] ||= {} %>
  <% params[:date_range]["relative_from"] ||= 50.years.to_i.to_s %>
  <% params[:date_range]["relative_to"]   ||= 1.months.to_i.to_s %>
  <%= date_range_panel(params[:date_range], "date_range", :date_attributes => [], :without_abs => true) %>
  </div>
  </p>
  <%= submit_tag 'Refresh' %>
<% end %>


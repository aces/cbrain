
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.  
#
-%>

<%
   info        = bourreau.info
   b_alive     = info.name != "???"
   diskrev     = info.revision
   runrev      = info.starttime_revision
   worker_pids = info.worker_pids
   worker_pids = nil if worker_pids == "???"
   tasks_tot   = info.tasks_tot
   tasks_max   = info.tasks_max
   tasks_max   = 'unlimited' if tasks_max.to_s == '0'
   isbourreau  = bourreau.is_a?(Bourreau)
   num_running = isbourreau ? CbrainTask.where( :bourreau_id => bourreau.id, :status => CbrainTask::ACTIVE_STATUS ).count : 0
   task_space_known = isbourreau ? CbrainTask.real_tasks.where( :bourreau_id => bourreau.id ).sum(:cluster_workdir_size)                                               : ""
   task_space_unkn  = isbourreau ? CbrainTask.real_tasks.where( :bourreau_id => bourreau.id, :cluster_workdir_size => nil ).where("cluster_workdir IS NOT NULL").count : ""
%>

<tr class="row_highlight <%= row_number % 2 == 0 ? "list-even" : "list-odd" %>" id="bourreau_<%= bourreau.id %>">
  <td><%= isbourreau ? "Execution" : "Portal" %></td>
  <td><%= link_to_bourreau_if_accessible(bourreau, current_user, :html_options => { :class => b_alive ? nil : 'error_link' } ) %></td>
  <% if @filter_params["details"] == 'on' %>
    <td>
        <% report = "Code:&nbsp;#{diskrev}&nbsp;Live:&nbsp;#{runrev}".html_safe %>
        <% if diskrev.to_s != runrev.to_s %>
          <%= red_if(true, report) %>
        <% else %>
          <%= red_if(diskrev.first == "(", report, nil, :color2 => 'purple') %>
        <% end %>
    </td>
    <td><%= link_to_user_with_tooltip(bourreau.user) %></td>
  <% end %>
  <td><%= link_to_group_if_accessible(bourreau.group) %></td>
  <% if @filter_params["details"] == 'on' %>
    <td><%= link_to_site_if_accessible(bourreau.site_affiliation) %></td>
    <td><%= bourreau.time_zone || "(Unset)" %></td>
  <% end %>
  <td><%= red_if( ! bourreau.online, "Yes", "Offline" ) %></td>
  <td>
      <% if ! b_alive %>
        <%= red_if( bourreau.online? , "-", "Down!" ) %>
      <% else %>
        <%= html_tool_tip("#{pretty_elapsed(info.uptime.to_i, :num_components => 2, :short => true)}", :offset_x => 50) do %>
          Since: <%= to_localtime(info.uptime.to_i.ago,:datetime) %>
          (for <%= pretty_elapsed(info.uptime.to_i) %>)
        <% end %>
      <% end %>
  </td>

  <% if isbourreau %>
    <td>
        <% if bourreau.online? %>
         <%= red_if( worker_pids.blank? , "Running (x #{worker_pids.to_s.split(",").size})" , "Stopped" ) %>
        <% else %>
          -
        <% end %>
    </td>
    <td><%= "#{tasks_tot}/#{tasks_max}" %></td>
    <td>
        <%= html_tool_tip(
           index_count_filter(num_running, :tasks, { :bourreau_id => bourreau.id, :status => :active }, :show_zeros => true),
           :tooltip_div_class => 'white_bg html_tool_tip'
           ) do %>
             <%= render :partial => 'load_info', :locals => { :bourreau => bourreau } %>
        <% end %>
    </td>
    <% if @filter_params["details"] == 'on' %>
      <td>
        <%= colored_pretty_size(task_space_known) %>
        <%= "(#{task_space_unkn} unkn)" if task_space_unkn > 0 %>
      </td>
    <% end %>
  <% else %>
    <td>-</td>
    <td>-</td>
    <td>-</td>
    <% if @filter_params["details"] == 'on' %>
      <td>-</td>
    <% end %>
  <% end %>

  <% if @filter_params["details"] == 'on' %>
    <td><%= overlay_description(bourreau.description) %></td>
  <% end %>

  <% if bourreau.has_owner_access?(current_user) %>

    <td>
      <% if RemoteResource.current_resource.id != bourreau.id %>
        <%= 
            delete_button 'Delete', bourreau_path(bourreau), :class  => "action_link", 
                                                         :confirm  => "Are you sure you want to delete '#{bourreau.name}' ?", 
                                                         :target  => "#bourreau_#{bourreau.id}",
                                                         :loading_message  => "<td colspan='17' style='color:red; text-align:center'>Deleting...</td>"
        %>
       <% end %>
    </td>

    <% if ! isbourreau %>
      <td colspan="2" />
    <% elsif ! bourreau.has_remote_control_info? %>
      <td><%= html_colorize("(Missing SSH control info)") %></td><td></td>
    <% elsif ! bourreau.has_actres_tunnelling_info? %>
      <td><%= html_colorize("(Missing ActiveResource SSH tunnel info)") %></td><td></td>
    <% elsif ! bourreau.has_db_tunnelling_info? %>
      <td><%= html_colorize("(Missing database SSH tunnel info)") %></td><td></td>
    <% else %>
      <td><%= link_to 'Start', start_bourreau_path(bourreau), :class => 'action_link', :method  => :post %></td>
      <td><%= link_to 'Stop',  stop_bourreau_path(bourreau),  :class => 'action_link', :method  => :post %></td>
    <% end %>

    <% if isbourreau %>
      <td><%= link_to 'Access?', { :controller => :tool_configs, :action => :index, :bourreau_id => bourreau.id }, :class => 'action_link' %></td>
    <% else %>
      <td></td>
    <% end %>

  <% else %>
    <td colspan="5"></td>
  <% end %>
</tr>

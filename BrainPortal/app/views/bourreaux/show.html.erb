
<% title 'Execution Server Info' %>

<h2>Information for <%= @bourreau.name %></h2>

<% is_bourreau = @bourreau.is_a?(Bourreau) %>

<div class="generalbox">
    
  <% if check_role(:admin) || @bourreau.user_id == current_user.id %>
    <div class="menu_bar menu_bar_left">
      <%= link_to 'Edit', edit_bourreau_path(@bourreau), { :class => "button" } %>
      <%= link_to 'Delete', bourreau_path(@bourreau), { :confirm => "Are you sure you want to delete '#{@bourreau.name}' ?", :method => :delete, :class => "button" } %>
    </div>
  <% end %>

  <P>

  <table class = "property_list">

    <tr>
      <th colspan="2" class="subtitle">Implementation information</th>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Name</th>
      <td class="left_align"><%= h(@bourreau.name) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Class</th>
      <td class="left_align"><%= h(@bourreau.class.to_s) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Revision Info (Client Side)</th>
      <td class="left_align"><%= h(Bourreau.revision_info.svn_id_pretty_rev_author_date) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Description</th>
      <td class="left_align"><%= overlay_description(@bourreau.description) %></td>
    </tr>

    <tr>
      <th colspan="2" class="subtitle">Access information</th>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Owner</th>
      <td class="left_align"><%= link_to_user_with_tooltip(@bourreau.user) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Project</th>
      <td class="left_align"><%= link_to_group_if_accessible(@bourreau.group) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Site</th>
      <td class="left_align"><%= link_to_site_if_accessible(@bourreau.site_affiliation) %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Time Zone</th>
      <td class="left_align"><%= h(@bourreau.time_zone || "(Unset)") %></td>
    </tr>

    <tr class="<%= cycle("list-odd", "list-even") %>">
      <th>Status</th>
      <td class="left_align"><%= h(@bourreau.online ? "Online" : "Offline") %></td>
    </tr>

    <% if check_role(:admin) || @bourreau.user_id == current_user.id %>

      <tr>
        <th colspan="2" class="subtitle">ActiveResource Configuration</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host</th>
        <td class="left_align"><%= h(@bourreau.actres_host) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Port</th>
        <td class="left_align"><%= h(@bourreau.actres_port) %></td>
      </tr>

      <tr>
        <th colspan="2" class="subtitle">SSH Remote Control Configuration</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host</th>
        <td class="left_align"><%= h(@bourreau.ssh_control_host) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>User</th>
        <td class="left_align"><%= h(@bourreau.ssh_control_user) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Port</th>
        <td class="left_align"><%= h(@bourreau.ssh_control_port) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Rails Server Directory</th>
        <td class="left_align"><%= h(@bourreau.ssh_control_rails_dir) %></td>
      </tr>

      <tr>
        <th colspan="2" class="subtitle">Tunnelling Configuration</th>
      </tr>

      <% if is_bourreau %>
      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Database Server Remote Tunnel Port</th>
        <td class="left_align"><%= h(@bourreau.tunnel_mysql_port) %></td>
      </tr>
      <% end %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>ActiveResource Remote Tunnel Port</th>
        <td class="left_align"><%= h(@bourreau.tunnel_actres_port) %></td>
      </tr>

      <tr>
        <th colspan="2" class="subtitle">Cache Management Configuration</th>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Cache Expiration Timeout (in seconds)</th>
        <td class="left_align"><%= h(@bourreau.cache_trust_expire) %></td>
      </tr>

    <% end %>

    <tr>
      <th colspan="2" class="subtitle">Runtime Information</th>
    </tr>

    <% if @info.name == "???" %>

      <tr>
        <td colspan="2">This server is currently <font color="red">DOWN</font>.</td>
      </tr>

    <% else %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Revision Info (Server Side)</th>
        <td class="left_align">
          <strong>Process Start Revision: </strong><%= @info.starttime_revision %><br>
          <strong>Code Subversion Revision: </strong><%= @info.revision %><br>
          <strong>Code Last Change Author: </strong><%= @info.lc_author %><br>
          <strong>Code Last Change Revision: </strong><%= @info.lc_rev %><br>
          <strong>Code Last Change Date: </strong><%= @info.lc_date %>
        </td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host name</th>
        <td class="left_align"><%= h(@info.host_name) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host IP address</th>
        <td class="left_align"><%= h(@info.host_ip) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host OS type</th>
        <td class="left_align"><%= h(@info.host_uname) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Host uptime</th>
        <td class="left_align"><%= h(@info.host_uptime) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Server uptime</th>
        <td class="left_align">
          Up since: <%= h(to_localtime(@info.uptime.to_i.ago,:datetime)) %><br>
          (for: <%= pretty_elapsed(@info.uptime.to_i) %>)
        </td>
      </tr>

      <% if is_bourreau %>
      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Worker PIDs</th>
        <td class="left_align"><%= @info.worker_pids %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Worker Revision Info</th>
        <td class="left_align">
          <strong>Last Change Author: </strong><%= @info.worker_lc_author %><br>
          <strong>Last Change Revision: </strong><%= @info.worker_lc_rev %><br>
          <strong>Last Change Date: </strong><%= @info.worker_lc_date %>
        </td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Number of tasks (running/max)</th>
        <td class="left_align"><%= h(@info.tasks_tot + " / " + @info.tasks_max) %></td>
      </tr>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>Cluster Management System</th>
        <td class="left_align">
          Type: <%= h(@info.bourreau_cms) %><br>
          Rev:  <%= h(@info.bourreau_cms_rev.svn_id_pretty_rev_author_date) %>
        </td>
      </tr>
      <% end %>

      <tr class="<%= cycle("list-odd", "list-even") %>">
        <th>SSH Public Key</th>
        <td class="left_align"><SMALL><SMALL><PRE class="ssh_key"><%= h(@info.ssh_public_key.strip) %><PRE></SMALL></SMALL></td>
      </tr>

    <% end %>

  </table>

  <% if is_bourreau %>

  <P>

  <table>
    <tr>
      <th colspan="<%= @statuses_list.size + 2 %>">Task Statistics</th>
    </tr>
    <tr>
      <th>User</th>
      <% @statuses_list.each do |stat| %>
        <th><%= h(stat) %></th>
      <% end %>
    </tr>
    <% sorted_users = @user_tasks_info.keys.sort { |a,b| a.login <=> b.login } %>
    <% sorted_users.each do |user| %>
      <% statcnt = @user_tasks_info[user] %>
      <% next if statcnt['TOTAL'].blank? || statcnt['TOTAL'] == 0 %>
      <tr>
        <td class="left_align"><%= link_to_user_with_tooltip(user) %></td>
        <% @statuses_list.each do |stat| %>
          <% if stat == "TOTAL" %>
            <td><%= filter_reset_link h(statcnt[stat]), :controller => :tasks, :filters  => {:bourreau_id => @bourreau.id, :user_id => user.id}, :ajax => false %></td>
          <% else %>
            <td><%= filter_reset_link h(statcnt[stat]), :controller => :tasks, :filters  => {:bourreau_id => @bourreau.id, :user_id => user.id, :status => stat}, :ajax => false %></td>
          <% end %>
        <% end %>
      </tr>
    <% end %>
    <tr>
      <td class="left_align">TOTAL</td>
      <% @statuses_list.each do |stat| %>
        <% if stat == "TOTAL" %>
          <td><%= link_to h(@statuses[stat]), :controller => :tasks, :action => :index %></td>
        <% else %>
          <td><%= filter_reset_link h(@statuses[stat]), :controller => :tasks, :filters  => {:bourreau_id => @bourreau.id, :status => stat}, :ajax => false %></td>
        <% end %>
      <% end %>
    <tr>
  </table>

  <% end %>

  <P>

  <%= render :partial => "layouts/log_report", :locals  => { :log  => @log, :title => "Server Log" } %>

</div>  <!-- End class="generalbox" -->


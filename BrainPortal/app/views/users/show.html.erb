
<% title "Account Info" %>

<div class="menu_bar">
  <% if check_role(:admin) %>
    <%= link_to 'Tool Access Reports', { :controller => :tool_configs, :user_id => @user.id }, :class => "button" %>
  <% end %>

  <%= link_to 'Report Maker',   { :controller => :portal, :action => :report }, :class => "button" %>
</div>

<br>

<%= error_messages_for :user, :header_message => "User could not be updated." %>

<div class="display_inline_block" style="min-width: 50%">
  <%= show_table(@user, :edit_path => user_path(@user), :edit_condition => edit_permission?(@user)) do |t| %>

    <% t.attribute_cell(:login) %>

    <%
      t.edit_cell(:role, :content => @user.role.humanize, :disabled => !((check_role(:admin) || check_role(:site_manager)) && not_admin_user(@user))) do 
        select_tag "user[role]", options_for_select(roles_for_user(current_user), :selected => @user.role), :class => "submit_onchange"
      end
    %>

    <% t.edit_cell(:full_name) { text_field_tag "user[full_name]", @user.full_name } %>

    <%
      t.edit_cell(:site_id, :content => link_to_site_if_accessible(@user.site), :disabled => !current_user.has_role?(:admin)) do
        select_tag "user[site_id]", options_for_select(Site.all.map{ |s| [s.name, s.id]}, :selected => @user.site_id), :include_blank => true, :class => "submit_onchange"
      end
    %>

    <% t.edit_cell(:email, :content => auto_link_email_addresses(h(@user.email))) { text_field_tag "user[email]", @user.email } %>

    <%
      t.cell("Last Connected") do
        @user.last_connected_at ? "#{to_localtime(@user.last_connected_at, :datetime)} (#{pretty_elapsed(Time.now - @user.last_connected_at, :num_components => 3)} ago)" : "(Never)"
      end
    %>

    <% t.edit_cell(:city) { text_field_tag "user[city]", @user.city } %>

    <%
      t.edit_cell("meta[pref_data_provider_id]", :header => "Default data provider", :content => link_to_data_provider_if_accessible(DataProvider.find_by_id(@user.meta["pref_data_provider_id"])) ) do
        data_provider_select("meta[pref_data_provider_id]",
                                 { :selector =>  @user.meta["pref_data_provider_id"] },
                                 { :include_blank => true, :class => "submit_onchange" } )
      end
    %>

    <% t.edit_cell(:country) { text_field_tag "user[country]", @user.country } %>

    <%
      t.edit_cell("meta[pref_bourreau_id]", :header => "Default Execution Server", :content => link_to_bourreau_if_accessible(Bourreau.find_by_id(@user.meta["pref_bourreau_id"])) ) do
        bourreau_select(     "meta[pref_bourreau_id]",
                                 { :bourreaux => Bourreau.find_all_accessible_by_user(current_user).all,
                                   :selector => @user.meta["pref_bourreau_id"] },
                                 { :include_blank => true, :class => "submit_onchange" } )
      end
    %>

    <%
      t.edit_cell(:time_zone, :content => (@user.time_zone || "(Unset)") ) do
        select_tag "user[time_zone]", time_zone_options_for_select(@user.time_zone, /canada/i), :include_blank => true, :class => "submit_onchange"
      end
    %>

    <% t.edit_cell(:password, :content => "********") do %>
         Password<br> <%= password_field_tag "user[password]" %><br>
         Confirm Password<br> <%= password_field_tag "user[password_confirmation]" %><br>
         <%= submit_tag 'Change Password' %>
    <% end %>

    <%
      if current_user.has_role?(:admin) && not_admin_user(@user)
        t.boolean_edit_cell('user[account_locked]', @user.account_locked, "1", "", :header => "Account Locked")
      end
    %>

  <% end %>

  <%= show_table(@user, :header => 'Resources') do |t| %>

    <% t.cell("Files") do
         size = Userfile.where(:user_id => @user.id).sum(:size)
         index_count_filter(@user.userfiles.count, :userfiles, { :user_id => @user.id }, :show_zeros => true ) +
         ( (size > 0) ? " (#{colored_pretty_size(size)} used)" : "" ).html_safe
       end
    %>

    <% t.cell("Tasks") do
         size = CbrainTask.real_tasks.where(:user_id => @user.id).sum(:cluster_workdir_size)
         unk  = CbrainTask.real_tasks.where(:user_id => @user.id, :cluster_workdir_size => nil).where("cluster_workdir IS NOT NULL").count
         index_count_filter(@user.cbrain_tasks.real_tasks.count, :tasks, {:user_id => @user.id}, :show_zeros => true ) +
         ( (size  > 0 && unk  > 0) ? " (#{colored_pretty_size(size)} used, #{unk} unkn)" :
           (size  > 0 && unk == 0) ? " (#{colored_pretty_size(size)} used)" :
           (size == 0 && unk  > 0) ? " (#{unk} unkn)" : ""
         ).html_safe
       end
    %>

    <% if current_user.has_role?(:admin) %>
      <% t.cell("Tools")          { index_count_filter @user.tools.count,                             :tools,          {:user_id => @user.id} } %>
      <% t.cell("Data Providers") { index_count_filter @user.data_providers.count,                    :data_providers, {:user_id => @user.id} } %>
      <% t.cell("Portal")         { index_count_filter BrainPortal.where(:user_id => @user.id).count, :bourreaux,      {:user_id => @user.id, :type => "BrainPortal"} } %>
      <% t.cell("Execution")      { index_count_filter Bourreau.where(:user_id => @user.id).count,    :bourreaux,      {:user_id => @user.id, :type => "Bourreau"} } %>
    <% end %>

  <% end %>


</div>

<% unless current_user.has_role? :admin %>

  <div>

   <table class="resource_list">
      <tr>
        <th colspan="3">
          Projects 
          <% if check_role(:admin) || check_role(:site_manager) %>
            <%= overlay_content_link "(Update)", :style => "text-decoration: underline; font-size: 0.9em", :enclosing_element => "span" do %>
              <%= form_for @user do |f| -%>
                <%= render :partial => 'shared/group_tables', :locals => {:model => @user} %><br>
                <%= submit_tag 'Update Projects' %>
              <% end %>
            <% end %>
          <% end %>
        </th>
      </tr>

      <tr>
        <th>Project Name</th>
        <th>Project Type</th>
        <th>Members</th>
      </tr>
  
   <% (@user.available_groups.sort { |g1,g2| g1.name.casecmp(g2.name) }).each do |group| %>
     <% next if group.name == 'everyone' %>
     <tr class=<%= cycle("list-even", "list-odd") %> >
       <td><%= link_to_group_if_accessible(group) %></td>
       <td><%= group.pretty_category_name(current_user) %></td>
       <td><%= array_to_table(group.users, :table_class => 'simple bordered') {|u,r,c| link_to_user_with_tooltip(u)} %></td>
     </tr>
   <% end %>

   </table>

  </div>

  <P>

<% end %>

  <%= render :partial => "layouts/log_report", :locals  => { :log  => @log, :title => 'User activity report' } %>


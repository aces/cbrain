
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
-%>

<div class="menu_bar">
   <%= new_model_button "Create Project", new_group_path %>
   <span id="view_option_button">
     <%= render :partial => "groups/view_option_button" %>
   </span>
   <%= overlay_ajax_link "Help", "/doc/groups/groups_info.html", :class  => "button" %>
</div>


<%= render :partial => 'shared/active_filters', :locals => {:model => :group} %>


<div class="pagination">
 <div class="pagination_left_side"></div>
  <div class="page_links">
    <%= will_paginate @groups, :inner_window => 5, :outer_window => 4, :container => false, :params => { :file_ids => nil } %>
    (<%= pluralize @total_entries, "projects" %>)
  </div>
  <div class="pagination_right_side">
    Search by name: <%= ajax_search_box "name_like", groups_path(:update_filter => :filter_hash) %>
  </div>
</div>


<% if @filter_params["button_view"] == "on" %>
  <% if !current_user.has_role?(:normal_user) %>
    <%=
      index_table([], :class => "project_button_header") do |t|
        t.sort_column("Name", Group, "name")
        t.column("Project Type", :filters => basic_filters_for(@filtered_scope, @header_scope, Group, :type))
        t.sort_column("Site", Site, "name", :filters => association_filters_for(@filtered_scope, @header_scope, Group, :site))
        t.empty("")
      end
    %>
  <% end %>
  <div>
    <%= group_legend(@groups) %>
  </div>
  <div>
    <% css_small = "small" if @filter_params["small_buttons"] == 'on' %>
    <% @groups.each do |g| %>
      <% if g == "ALL" %>
        <div style="color:black" data-href="<%= url_for(:action => :switch, :id => "all") %>" data-method="post" class="project_button <%= css_small %>">
          <h4 style="color:black">All</h4>
          <hr>
          Files: <%= @group_id_2_userfile_counts[nil] || "(None)" %><br>
          Tasks: <%= @group_id_2_task_counts[nil] || "(None)" %><br>
        </div>
      <% else %>
        <%
          user_count = @group_id_2_user_counts[g.id].to_i
          css_type   = css_group_type(g, user_count)
          desc_first = nil
          desc_rest  = nil
          if g.description.present?
            desc_lines = h(g.description).lines.to_a
            desc_first = desc_lines.shift.presence
            desc_rest  = desc_lines.join.presence
          end
         %>
        <div data-href="<%= url_for(:action => :switch, :id => g.id) %>" data-method="post" class="project_button <%= css_small %> <%= css_type %>_project">
          <h4><%= h crop_text_to(25, g.name) %></h4>
          <hr>
          <span class="project_user_count">
            <% if user_count > 1 %>
              Users: <%= user_count %>
            <% elsif css_type != "user" && user_count == 1 %>
              <% # FIXME can be rather slow, as it forces a query for each group with just one user %>
              User: <%= g.users.first.name %>
            <% end %>
          </span>&nbsp;&nbsp;
          Files: <%= @group_id_2_userfile_counts[g.id].to_i %>&nbsp;&nbsp;
          Tasks: <%= @group_id_2_task_counts[g.id].to_i %>
          <% if desc_first %>
            <div class="project_button_description"><%= crop_text_to(35, desc_first) %></div>
          <% end %>
          <div class="project_button_details">
            <% if desc_rest %>
              <div class="project_button_description project_details"><%= crop_text_to(120, desc_rest) %></div>
            <% end %>
            <%= link_to g.can_be_edited_by?(current_user) ? "Edit" : "Show", group_path(g), :class => "project_edit_button project_button_bottom_link", :title => "Edit" %>
            <% if g.is_a?(WorkGroup) && g.can_be_edited_by?(current_user) %>
              <%= delete_button "X", group_path(g), :class => "project_delete_button project_button_bottom_link", :title => "Delete", :confirm => "Are you sure you want to delete project '#{h g.name}'?" %>
            <% end %>
          </div>
        </div>
      <% end %>

    <% end %>

  </div>
<% else %>
  <%=
    index_table(@groups, :class => "resource_list") do |t|
      t.describe_sort_column("Name", Group, "name") do |col|
        col.cell(:class => "left") { |g|  link_to_group_if_accessible g}
      end
      t.sort_column("Description", Group, "description") { |g|  overlay_description(g.description) }
      t.sort_column("Project Type", Group, "type", :filters => basic_filters_for(@filtered_scope, @header_scope, Group, :type)) do |g|
        g.pretty_category_name(current_user)
      end
      t.sort_column("Site", Site, "name", :filters => association_filters_for(@filtered_scope, @header_scope, Group, :site)) { |g| link_to_site_if_accessible(g.site) }
      t.column("Users") { |g| @group_id_2_user_counts[g.id] || 0 }
      t.column("Files") do |g|
        index_count_filter @group_id_2_userfile_counts[g.id], :userfiles, {:group_id => g.id}, :show_zeros => true
      end
      t.column("Tasks") do |g|
        index_count_filter @group_id_2_task_counts[g.id], :tasks, {:group_id => g.id}, :show_zeros => true
      end
      if current_user.has_role?(:admin_user)
        t.column("Tools") do |g|
          index_count_filter @group_id_2_tool_counts[g.id], :tools, {:group_id => g.id}
        end
        t.column("Data Providers") do |g|
          index_count_filter @group_id_2_data_provider_counts[g.id], :data_providers, {:group_id => g.id}
        end
        t.column("Portal") do |g|
          index_count_filter @group_id_2_brain_portal_counts[g.id], :bourreaux, {:group_id => g.id, :type => "BrainPortal"}
        end
        t.column("Execution") do |g|
          index_count_filter @group_id_2_bourreau_counts[g.id], :bourreaux, {:group_id => g.id, :type => "Bourreau"}
        end
      end
      t.column("Switch") do |g|
        link_to 'Switch', {:action => :switch, :id => g.id}, :class => 'action_link', :method  => :post
      end
    end
  %>
<% end %>


<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
-%>

<% title "Project Info" %>

<% if @group.is_a?(WorkGroup) %>
  <div class="menu_bar">
    <% unless @group.creator_id == current_user.id %>
      <%= link_to 'Unregister', {:action => :unregister, :id => @group.id}, :class => "button", :method  => :post %>
    <% end %>
    <% if @group.can_be_edited_by?(current_user) %>

        <%= link_to 'Switch', {:action => :switch, :id => @group.id}, :class => "button", :method  => :post %>
        <% if @group.can_be_edited_by?(current_user) && current_user.visible_users.count > 0 %>
          <%= overlay_ajax_link "Invite Other Users", new_invitation_path(group_id: @group.id), class: "button" %>
        <% end %>
        <%= link_to 'Delete', group_path(@group), { :data => { :confirm => "Are you sure you want to delete '#{@group.name}'?" }, :method => :delete, :class => "button" } %>
    <% end %>
    </div>
<% end %>

<P>

<%= error_messages_for @group, :header_message => "Project could not be updated." %>

<div class="display_inline_block" style="min-width: 50%">

  <%= show_table(@group, :as => :group, :edit_condition => @group.can_be_edited_by?(current_user)) do |t| %>

    <% t.edit_cell(:name) do |f| %>
      <%= f.text_field :name %>
    <% end %>

    <% t.edit_cell(:creator_id, :content => link_to_user_with_tooltip(@group.creator), :header => "Maintainer") do %>
      <%= user_select "group[creator_id]", { :users => ( current_user.available_users | @group.users), :selector => @group.creator } %>
      <div class="field_explanation">
        <span class="warning">Warning</span>:
          If you change the maintainer to someone else you won't be able to retrieve control over the project
      </div>
    <% end %>

    <% t.edit_cell(:site_id, :content => link_to_site_if_accessible(@group.site), :disabled => !current_user.has_role?(:admin_user)) do %>
      <%= site_select "group[site_id]", @group.site_id, :prompt => "(Select a site)" %>
    <% end %>

    <% t.cell("Type") { @group.pretty_category_name(current_user) } %>

    <% t.edit_cell(:description, :content =>  full_description(@group.description)) do |f| %>
        <%= f.text_area :description, :rows => 4, :cols => 40 %><br>
        <div class="field_explanation">The first line should be a short summary, and the rest are for details.</div><br>
    <% end %>

    <% if current_user.has_role?(:admin_user) && @group.is_a?(WorkGroup) %>
      <% t.edit_cell("Invisible", :content => check_box_tag(nil ,nil, @group.invisible?, :disabled => true)) do |f| %>
        <%= f.check_box :invisible %>
      <% end %>
    <% else %>
      <% t.empty_cell %>
    <% end %>

  <% end %>

  <%= show_table(@group, :header => 'Resources') do |t| %>

    <% t.cell("Files") { index_count_filter @group.userfiles.count, :userfiles, {:group_id => @group.id}, :show_zeros => true } %>

    <% t.cell("Tasks") { index_count_filter @group.cbrain_tasks.count, :tasks, {:group_id => @group.id}, :show_zeros => true } %>

    <% if current_user.has_role?(:admin_user) %>
      <% t.cell("Tools") { index_count_filter @group.tools.count, :tools, {:group_id => @group.id} }%>
      <% t.cell("Data Providers") { index_count_filter @group.data_providers.count, :data_providers, {:group_id => @group.id} } %>
      <% t.cell("Portal") { index_count_filter BrainPortal.where(:group_id => @group.id).count, :bourreaux, {:group_id => @group.id, :type => "BrainPortal"} } %>
      <% t.cell("Execution") { index_count_filter Bourreau.where(:group_id => @group.id).count, :bourreaux, {:group_id => @group.id, :type => "Bourreau"} } %>
    <% end %>

  <% end %>

  <% if current_user.has_role?(:admin_user) %>
    <% group_access_profiles = @group.access_profiles
                               .order('access_profiles.name')
                               .map { |ap| access_profile_label(ap, :with_link => true) }
                               .join("").html_safe
       group_access_profiles = "(None)" if group_access_profiles.blank?
    %>

    <%= show_table(@group, :header => 'Assigned To Access Profiles') do |t| %>
      <% t.cell("", :no_header => true, :show_width => 2) do %>
        <span><%= group_access_profiles %></span>
      <% end %>
    <% end %>
  <% end %>

  <%
    group_members  = @group.users
    group_editors  = @group.editors || []
    group_editors << @group.creator unless group_editors.include? @group.creator
    group_viewers  = group_members - group_editors
    open_invites   = Invitation.where(sender_id: current_user.id, group_id: @group.id, active: true).to_a

    if @group.is_a?(WorkGroup) then # for now editors are only allowed on WorkGroups
      members_header = 'Members and Their Project Roles'
      default_text = ''
      if group_editors.any? then
        default_text += '<label>Can edit:</label>'
        default_text += array_to_table(group_editors.sort{ |a,b| a.login.casecmp(b.login)}, :table_class => 'simple bordered float_left', :cols => 20, :min_data => 20, :fill_by_columns => true ) { |u,r,c| link_to_user_with_tooltip(u)}
        default_text += ' '
      end
      if group_viewers.any? then
        default_text += '<label>Cannot edit:</label>'
        default_text += array_to_table(group_viewers.sort{ |a,b| a.login.casecmp(b.login)}, :table_class => 'simple bordered float_left', :cols => 20, :min_data => 20, :fill_by_columns => true ) { |u,r,c| link_to_user_with_tooltip(u)}
      end
      default_text = default_text.html_safe
    else
      members_header = 'Members'
      default_text = array_to_table(group_members.sort{ |a,b| a.login.casecmp(b.login)}, :table_class => 'simple bordered float_left', :cols => 20, :min_data => 20, :fill_by_columns => true ) { |u,r,c| link_to_user_with_tooltip(u)}
    end

  %>

  <%= show_table(@group, :as => :group, :header => members_header, :edit_condition => @group.can_be_edited_by?(current_user) && (!current_user.has_role?(:normal_user) || group_members.count > 1 || open_invites.count > 0 )) do |t| %>
    <% t.edit_cell(:user_id, :show_width => 2,
                             :no_header  => 'Members',
                             :content    => default_text) do %>
      <% if current_user.has_role? :normal_user or @group.is_a?(WorkGroup) %>
        <table class="button_table">
          <tr>
            <th>Username</th>
            <% if @group.is_a?(WorkGroup) %>
              <th>Can edit?</th>
            <% end %>
            <th>Revoke membership</th>
          </tr>
        <% group_members.each do |u| %>
          <tr>
            <td>
              <%= link_to_user_with_tooltip u %>
            </td>
            <%  if @group.is_a?(WorkGroup) %>
              <td>
                <%= check_box_tag("group[editor_ids][]", u.id, @group.editor_ids.include?(u.id),
                      :checked => u.id == @group.creator.id, :disabled=> u.id == @group.creator) %>
              </td>
            <% end %>
            <td>
              <%= link_to("Remove", remove_users_group_path(@group, "user_ids" => ([u.id])), :method => :put, :class => "action_link") unless u == current_user || u==@group.creator %>
            </td>
          </tr>
        <% end %>
        </table>
        <%= hidden_field_tag("group[editor_ids][]", []) %>
      <% end %>
    <% end %>

    <% if open_invites.present? %>
      <% default_text = array_to_table(open_invites.map(&:user).sort{ |a,b| a.login.casecmp(b.login)}, :table_class => 'simple bordered float_left', :cols => 20, :min_data => 20, :fill_by_columns => true ) { |u,r,c| u.login } %>

      <% t.edit_cell(:invites, :show_width => 2,
                               :header     => 'Pending Invitations',
                               :content    => default_text) do %>
        <% open_invites.each do |i| %>
          <%= link_to_user_with_tooltip i.user %>: <%= link_to("Cancel", invitation_path(i), :method => :delete, :class => "action_link") %>
          <br>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>

<% if not current_user.has_role? :normal_user %>
  <%
    group_members  = @group.users
  %>
  <%= show_table(@group, :as => :group, :header => "Quick Membership Control", :edit_condition => @group.can_be_edited_by?(current_user) ) do |t| %>
    <% default_text = array_to_table(group_members.sort{ |a,b| a.login.casecmp(b.login)}, :table_class => 'simple bordered float_left', :cols => 20, :min_data => 20, :fill_by_columns => true ) { |u,r,c| link_to_user_with_tooltip(u) } %>
    <% t.edit_cell(:user_id, :show_width => 2, :no_header  => 'Members',  :content => default_text) do %>
      <div class="generalbox" style="width: 100%">
        <%= render :partial => 'users_form' %><br>
      <%= hidden_field_tag :update_users, true %>
      </div>
    <% end %>
  <% end %>
<% end %>

<% if @group.can_be_edited_by?(current_user) %>
  <P>
  <%= render :partial => "layouts/log_report", :locals  => { :log  => @group.getlog, :title => 'Project Log' } %>
<% end %>


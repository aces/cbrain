<div class="menu_bar">
  <% if current_user.has_role?(:admin) %>
    <%= new_model_button 'Create New Tool', new_tool_path %>
       
    <span title="Registers all subclasses of PortalTask as Tools">
      <%= link_to 'Autoload Tools', { :action  => :create, :autoload  => true}, :method  => :post, :class => " button" %>
    </span>
            
    <%= link_to 'Access Reports', { :controller => :tool_configs, :action => :index }, :class => " button" %>
  <% end %>

  <%= overlay_ajax_link "Help", "/doc/tool/tool_info.html", :class  => "button" %>
</div> 

<div class="active_filters">
  <%= render :partial => 'shared/active_filters', :locals => {:model => :tool} %>
</div>

<%= index_table(@tools, :class => "resource_list") do |t| %>
  <% 
    t.sort_column("Tool Name", Tool, :name, &:name)
    t.sort_column("Description", Tool, :description) { |tool|  overlay_description(tool.description) } 
    t.sort_column("Category", Tool, :category, :filters => basic_filters_for(@header_scope, Tool, :category), &:category)
    t.sort_column("Owner", User, :login, :filters => association_filters_for(@header_scope, Tool, :user, :name_method => :login)) { |tool| link_to_user_with_tooltip(tool.user) }
    t.sort_column("Project", Group, :name, :filters => association_filters_for(@header_scope, Tool, :group)) { |tool| link_to_group_if_accessible(tool.group) }
    t.describe_column("Execution & Versions") do |col|
      col.cell(:class => "left") do |tool|
        result = ""
        tool.bourreaux.sort{|a, b| a.name.casecmp(b.name)}.each do |b|
          tcs = ToolConfig.where( :bourreau_id => b.id, :tool_id => tool.id ).all
puts_red tcs.inspect        
          tcs.reject! { |tc| ! tc.can_be_accessed_by?(current_user) }
          result += link_to_bourreau_if_accessible(b)
          if tcs.size >= 1
            result += " (#{pluralize tcs.size, "version"})"
          end
          result += "<br/>"
        end
        result.html_safe
      end
    end
    if current_user.has_role?(:admin)
      t.describe_column("Operations") do |col|
        col.edit_link
        col.delete_link
        col.cell { |tool| link_to 'Access?', { :controller => :tool_configs, :action => :index, :tool_id => tool.id }, :class => "action_link" }
      end
    end
    t.describe_column("Help/Info") do |col|
      col.cell do |tool|
        tool_plain_name = tool.cbrain_task_class.demodulize.underscore
        help_path = "/doc/tasks/#{tool_plain_name}_options.html"
        if File.exist?( Rails.root.to_s + "/public" + help_path )
          overlay_ajax_link "Help", help_path
        end
      end
      col.cell do |tool|
        tool_plain_name = tool.cbrain_task_class.demodulize.underscore
        info_path = "/doc/tasks/#{tool_plain_name}_info/#{tool_plain_name}_info.html"
        if File.exist?( Rails.root.to_s + "/public" + info_path )
          overlay_ajax_link "Info", info_path
        end
      end
    end
  %>
<% end %>



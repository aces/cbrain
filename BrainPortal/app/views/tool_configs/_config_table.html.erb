
<%-
  #
  # CBRAIN Project
  #
  # Copyright (C) 2008-2012
  # The Royal Institution for the Advancement of Learning
  # McGill University
  #
  # This program is free software: you can redistribute it and/or modify
  # it under the terms of the GNU General Public License as published by
  # the Free Software Foundation, either version 3 of the License, or
  # (at your option) any later version.
  #
  # This program is distributed in the hope that it will be useful,
  # but WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  # GNU General Public License for more details.
  #
  # You should have received a copy of the GNU General Public License
  # along with this program.  If not, see <http://www.gnu.org/licenses/>.
  #
-%>



<% if @tool_config.tool_id && @tool_config.bourreau_id %>
  <div class="display_inline_block" style="min-width: 50%">

    <%= show_table(@tool_config, :header => "Configuration info", :edit_condition => check_role(:admin_user)) do |t| %>

      <%= hidden_field_tag "tool_config[tool_id]",     @tool_config.tool_id %>
      <%= hidden_field_tag "tool_config[bourreau_id]", @tool_config.bourreau_id %>


      <% t.edit_cell(:group_id, :header => "Available to members of project", td_options: {:title => "Project access for this configuration."}) do %>
        <%= group_select "tool_config[group_id]", @tool_config.group_id %>
      <% end %>

      <% t.edit_cell(:version_name, :header => "Version", td_options: {:title => "Version"}) do |f|  %>
        <%= f.text_field :version_name %>
        <%#raw '<div class="field_explanation"> Must be a simple string that represent a short identifier for the version. First character must be alphanum, and can contain only alphanums, \'.\', \'-\', \'_\', \':\' and \'@\' </div>' %>
      <% end %>

      <% t.edit_cell(:description, :header => "Description", td_options: {:title => "Brief description for this configuration"}) do |f|  %>
        <%= f.text_area :description, :rows => 10, :cols => 40 %>
        <%#raw '<div class="field_explanation">The first line must be a short summary, and the rest are for any special notes for the users.</div>' %>
      <% end %>

      <% t.edit_cell(:ncpus, :header => "Suggested number of CPUs per task", td_options: {:title => "Suggested number of CPUs to use in parallel, per task"}) do |f|  %>
        <%= f.select :ncpus, [ 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 14, 16, 20, 24, 32, 36, 40, 48, 56, 64, 128, 192, 256, 320, 384, 512 ] %>
      <% end %>

    <% end %>
  </div>
<% end %>

<div class="display_inline_block" style="min-width: 50%">
  <% context = @tool_config.tool_id ? "tool" : "Execution Server" %>
  <%= show_table @tool_config,  :header => "Environment variables", :edit_condition => check_role(:admin_user) do |t| %>
    <% @tool_config.env_array.each do |env_name_value| %>
        <% env_name  = env_name_value[0] %>
        <% env_value = env_name_value[1] %>
        <% render :partial => 'env_key_value_pair_2', :locals => { :env_name => env_name, :env_value => env_value, :t => t } %>
    <% end %>
    <% 1.upto(5) do %>
        <% render :partial => 'env_key_value_pair_2', :locals => { :env_name => "", :env_value => "", :t => t } %>

    <% end %>
    <% t.row() do |f| %>
      <% hidden_field_tag "tool_config[tool_id]",     @tool_config.tool_id %>
      <% hidden_field_tag "tool_config[bourreau_id]", @tool_config.bourreau_id %>
      <%= render :partial => 'field_explanation', :locals => { :txt =>
             "In the generated script, the values shown here will be placed in double quotes automatically."}  %>

    <% end %>


  <% end %>
</div>

<div class="display_inline_block" style="min-width: 50%">
  <%= show_table @tool_config,  :header => "BASH initialization prologue", :edit_condition => check_role(:admin_user) do |t| %>
    <% t.edit_cell(:script_prologue, :header => "BASH") do |f|  %>
      <%= f.text_area :script_prologue, :cols => 80, :rows => 10 %>

        <%= render :partial => 'field_explanation', :locals => { :txt => <<-TEXT.chomp
           This is a multi line partial BASH script. It can use the environment variables defined above
           and do anything else you feel is needed to activate this configuration.
           Note that this script should usually be silent, as outputing text (like in <em>echo</em> statements)
           could interfere with the proper processing of the task's output."
TEXT
        }%>
    <% end %>
  <% end %>
</div>

<div class="display_inline_block" style="min-width: 50%">

  <%= show_table @tool_config,  :header => "Option: Merge configuration from another existing entry", :edit_condition => check_role(:admin_user) do |t| %>

  <% end %>

</div>

<div class="display_inline_block" style="min-width: 50%">

  <%= show_table @tool_config,  :header => "Container configuration", :edit_condition => check_role(:admin_user) do |t| %>
    <% t.edit_cell(:container_engine, :header => "Container engine") do |f|  %>
      <%= f.select :container_engine, [["None", ''], ['Docker', 'Docker'], ['Singularity', 'Singularity']], :title => 'Container type' %>
    <% end %>

    <% t.edit_cell(:container_index_location, :header => "Index of the container image") do |f|  %>
      <% f.text_field :container_index_location %>
      <% render :partial => "field_explanation", :locals => {:txt => <<-TEXT.chomp
        The index/url of the container image in which the docker/singularity container is
        accessible through.
        Examples for Docker are: quay.io, index.docker.io (default).
        Examples for Singularity are: docker://, shub:// (default).
TEXT
      } %>
    <% end %>

    <% t.edit_cell(:containerhub_image_name, :header => "Container image name") do |f|  %>
      <% f.text_field :containerhub_image_name %>
      <% render :partial => "field_explanation", :locals => {:txt => <<-TEXT.chomp

        The name and tag of the container image in which the tool is installed,
        for instance "centos:latest". This name refers to the Docker/Singulariry index
        accessed by the Bourreau, which is configured manually in the Bourreau
        for now.
TEXT
      } %>
    <% end %>
    <% t.edit_cell(:container_image_userfile_id, :header => "ID of the container image") do |f|  %>
      <%= f.text_field :container_image_userfile_id %> <%= link_to_userfile_if_accessible(@tool_config.container_image) %>
      <%= '<div class="field_explanation"> The ID number of the container image in which the tool is installed. This ID refers to userfile registered in CBRAIN.  </div>' %>
    <% end %>
    <% t.edit_cell(:extra_qsub_args, :header => "Extra 'qsub' options") do |f|  %>
      <%= f.text_field :extra_qsub_args %>
      <%=raw  '<div class="field_explanation"><b>Note:</b> This option will be appended to the extra \'qsub\' option defined at the bourreau level.</div>'  %>
    <% end %>
  <% end %>
</div>

  <% bourreau = @tool_config.bourreau %>
  <% if !bourreau.nil? && bourreau.scir_class < ScirCloud %>
    <% available_disk_images    = bourreau.scir_class.get_available_disk_images(bourreau)
       available_instance_types = bourreau.scir_class.get_available_instance_types(bourreau)
       available_ssh_key_pairs  = bourreau.scir_class.get_available_key_pairs(bourreau)
    %>


    <div class="display_inline_block" style="min-width: 50%">

    <%= show_table @tool_config,  :header => "Cloud configuration", :edit_condition => check_role(:admin_user) do |t| %>

      <% t.edit_cell(:cloud_vm_user, header: "VM user") do |f| %>
          <%= f.text_field :cloud_vm_user%>
      <% end %>
      <% t.edit_cell(:cloud_ssh_key_pair, header: "SSH key pair") do |f| %>
          <%= f.select :cloud_ssh_key_pair,  available_ssh_key_pairs %>
      <% end %>
      <% t.edit_cell(:cloud_instance_type, header: "Instance type") do |f| %>
          <%= f.select :cloud_instance_type,  available_instance_types %>
      <% end %>
      <% t.edit_cell(:cloud_job_slots, header: "Job slots") do |f| %>
          <%= f.text_field :cloud_job_slots%>
      <% end %>
      <% t.edit_cell(:cloud_vm_boot_timeout, header: "VM boot timeout (s)") do |f| %>
          <%= f.text_field :cloud_vm_boot_timeout%>
      <% end %>
      <% t.edit_cell(:cloud_vm_ssh_tunnel_port, header: "VM SSH tunnel port") do |f| %>
          <%= f.text_field :cloud_vm_ssh_tunnel_port%>
      <% end %>

    <% end %>
  <% end %>
  </div>




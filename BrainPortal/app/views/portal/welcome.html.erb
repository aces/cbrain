
<script type="text/javascript">
  window.onload=function() {
    Nifty("div.task_summary","big");
  }
</script>

<h1>Welcome to CBRAIN, <%= current_user.full_name %></h1>

<div class="display_cell">

  <% if current_user.has_role?(:admin) %>
    <h1><%= link_to_bourreau_if_accessible(RemoteResource.current_resource, current_user, :name => "System Info") %></h1>

    <div class="generalbox no_wrap">
      <% if @active_users %>
        <p>
          <strong>Users Currently Online:</strong> <%= h(@active_users.map(&:login).join(", ")) %>
        </p>
        <p><strong>Recent Activity:</strong></p>
        <% Session.recent_activity.each do |entry| %>
          <%= link_to_user_if_accessible entry[:user] %><%= ", #{h entry[:user].city}" if  entry[:user].city%>: <%= distance_of_time_in_words(entry[:last_access], Time.now) %> ago.<br>
        <% end %>
      <% end %>
      <br>
      <% if current_user.has_role? :admin %>
        <% form_tag home_path do %>
          <% if BrainPortal.current_resource.portal_locked? %>
            <%= hidden_field_tag :lock_portal, "unlock" %>
            <%= submit_tag "Unlock this Portal", {:confirm => "Are you sure you wish to unlock this portal?"} %>
          <% else %>
            <%= hidden_field_tag :lock_portal, "lock" %>
            <%= submit_tag "Lock this Portal", {:confirm => "Are you sure you wish to lock this portal?"} %>
          <% end %>
        <% end %>  
      <% end %>
    </div>
  <% end %>

</div>

<div class="display_cell">
  <h1><%= link_to "Account Info", user_path(current_user) %></h1>
  
  <div class="generalbox">
    <p>
      <strong>Your login name:</strong> <%= link_to_user_if_accessible(current_user) %>
    </p>
    <p>
      <strong>Your full name:</strong> <%= current_user.full_name %>
    </p>
    <p>
      <strong>Your site affiliation:</strong> <%= link_to_site_if_accessible(current_user.site) %>
    </p>
    <p>
      <strong>Your time zone:</strong> <%= red_if(current_user.time_zone.blank?,h(current_user.time_zone),"(Unset)") %><BR>
      <strong>Your current time:</strong> <%= to_localtime(Time.now, :datetime) %><BR>
    </p>
    <p>
       <strong>Projects you belong to:</strong>  <%= @groups.map { |g| link_to_group_if_accessible(g) }.join(", ") %>
    </p>
    <p>
       <strong>Tools available to you:</strong> <%= h(current_user.available_tools.map(&:name).sort.join(", ")) %>
    </p>
   <p>
    <strong>Your default Data Provider:</strong> <%= link_to_data_provider_if_accessible(@default_data_provider) %>
   </p>
    <p>
      <strong>Your default Execution Server:</strong> <%= link_to_bourreau_if_accessible(@default_bourreau) %>
    </p>
  </div>

</div>



<div class="display_cell">
  <h1><%= link_to "Tasks", :controller  => :tasks,  :action  => :index %></h1>

   <div id="completed_task_summary" class="task_summary">
     <div class="task_summary_count">
       Completed tasks: <%= @tasks_by_status[:completed].size %>
       <P>
       <%= link_to "Go to Index Page", :controller  => :tasks,  :action  => :index, :tasks  => {:filters => {:status  => :completed}} %>
     </div>
     <% unless @tasks_by_status[:completed].blank? %>
       <table class="task_summary_table">
         <tr><th colspan="2">Recent Activity</th></tr>
         <% for task in @tasks_by_status[:completed].sort{ |a,b|  b.updated_at <=> a.updated_at}[0..4] %>
           <tr>
             <td><%= link_to_task_if_accessible(task) %></td>
             <td><%= to_localtime(task.updated_at,:datetime) %></td>
           </tr>
         <% end %>
       </table>
     <% end %>
   </div>

   <P>

   <div id="running_task_summary" class="task_summary">
     <div class="task_summary_count">
       Running tasks: <%= @tasks_by_status[:running].size %>
       <br><br>
       <%= link_to "Go to Index Page", :controller  => :tasks, :action  => :index, :tasks  => {:filters => {:status  => :running}} %>
     </div>
     <% unless @tasks_by_status[:running].blank? %>
       <table class="task_summary_table">
         <tr><th colspan="2">Recent Activity</th></tr>
         <% for task in @tasks_by_status[:running].sort{ |a,b|  b.updated_at <=> a.updated_at}[0..4] %>
           <tr>
             <td><%= link_to_task_if_accessible(task) %></td>
             <td><%= to_localtime(task.updated_at,:datetime) %></td>
           </tr>
         <% end %>
       </table>
     <% end %>
   </div>

   <P>

   <div id="failed_task_summary" class="task_summary">
     <div class="task_summary_count">
       Failed tasks: <%= @tasks_by_status[:failed].size %>
       <br><br>
       <%= link_to "Go to Index Page", :controller  => :tasks, :action  => :index, :tasks  => {:filters => {:status  => :failed}} %>
     </div>
     <% unless @tasks_by_status[:failed].blank? %>
       <table class="task_summary_table">
         <tr><th colspan="2">Recent Activity</th></tr>
         <% for task in @tasks_by_status[:failed].sort{ |a,b|  b.updated_at <=> a.updated_at}[0..4] %>
           <tr>
             <td><%= link_to_task_if_accessible(task) %></td>
             <td><%= to_localtime(task.updated_at,:datetime) %></td>
           </tr>
         <% end %>
       </table>
     <% end %>
   </div>

</div>


<%-
#
# NeuroHub Project
#
# Copyright (C) 2020
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
-%>

<% file_icon = '<svg id="files" xmlns="http://www.w3.org/2000/svg" viewBox="125 10 250 130">
<path id="Rounded_Rectangle_14_copy-3" data-name="Rounded Rectangle 14 copy" style="stroke-width: 10px; fill-rule: evenodd; fill: none;" d="M310.072,136.3V10.646a2.6,2.6,0,0,0-2.534-2.661H187.556a2.6,2.6,0,0,0-2.535,2.661V154.322a2.6,2.6,0,0,0,2.535,2.661H289.685Z"/>
<path id="Rounded_Rectangle_14_copy_2-3" data-name="Rounded Rectangle 14 copy 2" style="stroke-width: 4px; fill-rule: evenodd; fill: none;" d="M308.3,133.037H289.66a2.636,2.636,0,0,0-2.647,2.625v17.773"/>
<path id="Rounded_Rectangle_11-3" data-name="Rounded Rectangle 11" style=" stroke-width: 4px; fill-rule: evenodd;" d="M206.729,41.6h80.915a3,3,0,0,1,3,3v1.511a3,3,0,0,1-3,3H206.729a3,3,0,0,1-3-3V44.6A3,3,0,0,1,206.729,41.6Z"/>
<path id="Rounded_Rectangle_11_copy-3" data-name="Rounded Rectangle 11 copy" style="stroke-width: 4px; fill-rule: evenodd;" d="M206.673,64.469h80.916a3,3,0,0,1,3,3V68.98a3,3,0,0,1-3,3H206.673a3,3,0,0,1-3-3V67.469A3,3,0,0,1,206.673,64.469Z"/>
<path id="Rounded_Rectangle_11_copy_2-3" data-name="Rounded Rectangle 11 copy 2" style="stroke-width: 4px; fill-rule: evenodd;" d="M207.505,87.5H288.42a3,3,0,0,1,3,3v1.511a3,3,0,0,1-3,3H207.505a3,3,0,0,1-3-3V90.5A3,3,0,0,1,207.505,87.5Z"/>
<path id="Rounded_Rectangle_11_copy_3-3" data-name="Rounded Rectangle 11 copy 3" style="stroke-width: 4px; fill-rule: evenodd;" d="M207.477,110.56h80.888a3,3,0,0,1,3,3v1.511a3,3,0,0,1-3,3H207.477a3,3,0,0,1-3-3V113.56A3,3,0,0,1,207.477,110.56Z"/>
</svg>'.html_safe
%>

<% project_icon = '<svg xmlns="http://www.w3.org/2000/svg" width="72" height="69" viewBox="-10 0 100 69"><path id="Rounded_Rectangle_1" data-name="Rounded Rectangle 1" style="fill: none;stroke-width: 6px;fill-rule: evenodd;" d="M4.77,16H28.243c1.471,0,2.676,4.837,4.176,4.837,16.363,0,34.811-.317,34.811-0.317a0.782,0.782,0,0,1,.77.793V64.207a0.782,0.782,0,0,1-.77.793H4.77A0.782,0.782,0,0,1,4,64.207V16.793A0.782,0.782,0,0,1,4.77,16Z"/></svg>'.html_safe %>

<% user_icon = '<svg fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-width="0" stroke-miterlimit="10" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title" viewBox="0 0 32 32" preserveAspectRatio="xMidYMid meet" class="InlineSvg-gigSlh hwPeQh"><g><path d="M16.981,17c0,1.683 -0.271,2.241 -0.469,2.456c-0.163,0.176 -0.68,0.544 -2.531,0.544c-1.85,0 -2.367,-0.368 -2.53,-0.544c-0.198,-0.215 -0.47,-0.773 -0.47,-2.456c0,-1.657 1.343,-3 3,-3c1.657,0 3,1.343 3,3Zm0.835,3.977c0.879,-0.804 1.165,-2.104 1.165,-3.977c0,-2.761 -2.238,-5 -5,-5c-2.761,0 -5,2.239 -5,5c0,1.873 0.287,3.173 1.166,3.977c-1.665,0.911 -2.97,2.396 -3.649,4.189c-0.124,0.328 -0.154,0.708 0.051,0.993c0.569,0.789 1.674,-0.111 2.13,-0.97c1.008,-1.897 3.004,-3.189 5.302,-3.189c2.298,0 4.295,1.292 5.303,3.189c0.456,0.859 1.561,1.759 2.129,0.97c0.205,-0.285 0.176,-0.665 0.052,-0.993c-0.68,-1.793 -1.985,-3.278 -3.649,-4.189Z"></path></g></svg>'.html_safe
%>

<%
   @files    = @results[:files][0,@limit]
   @tasks    = @results[:tasks][0,@limit]
   @projects = @results[:groups][0,@limit]
%>

<% title("Search", '') %>

<%= form_tag(nh_search_path, :method => :get) do %>

   <strong>Search:</strong> <%= text_field_tag :search, @search.presence, :placeholder => "Search for anything" %>
   <span class="field_explanation">This will search files, tasks, projects by ID, by name or by description. <%= @limit %> results shown maximum.</span>
   <p>
<% end %>

<div id="nh_dashboard">

  <div class="main">

    <div class="section user">
      <% if @tasks.size > 0 %>
        <div class="card">
          Task
          <div>
            <% for task in @tasks %>
              <div class="card-row">
                <div class="card-section">
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <%= link_to_task_if_accessible(task, nil, :name_method => :name_and_bourreau) %>
                  </div>
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <div class="text-ellipsis"><%= user_icon %>
                     <%= link_to_user_if_accessible(task.user) %>
                    </div>
                  </div>
                </div>
                <div class="card-section">
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <%= project_icon %>
                    <%= link_to_group_if_accessible(task.group) %>
                  </div>
                  <div class="card-item text-ellipsis">
                    <%= colored_status(task.status) %>
                  </div>
                  <div class="card-item text-ellipsis">
                    <%= to_localtime(task.updated_at,:date) %>
                    <%= to_localtime(task.updated_at,:time) %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @files.size > 0 %>
        <div class="card">
          Files
          <div>
            <% for file in @files %>
              <div class="card-row">
                <div class="card-section">
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <%= file_icon %>
                    <%= link_to_userfile_if_accessible(file, nil) %>
                  </div>
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <div class="text-ellipsis"><%= user_icon %><%= link_to_user_if_accessible(file.user, nil) %></div>
                  </div>
                </div>
                <div class="card-section">
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <%= project_icon %>
                    <%= link_to_group_if_accessible(file.group) %>
                  </div>
                  <div class="card-item text-ellipsis">
                    <%= colored_pretty_size(file.size) %>
                  </div>
                  <div class="card-item text-ellipsis">
                    <%= to_localtime(file.updated_at,:date) %>
                    <%= to_localtime(file.updated_at,:time) %>
                  </div>
                </div>

              </div>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @projects.size > 0 %>
        <div class="card">
          Groups
          <div>
            <% for project in @projects %>
              <div class="card-row">
                <div class="card-section">
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <%= project_icon %>
                    <%= link_to project.name, {:controller => :nh_projects, :action => :show, :id => project.id}, :method  => :get, :class=>"btn-text-secondary bg-default-wash" %>
                  </div>
                  <div class="card-item text-ellipsis btn-text-secondary">
                    <div class="text-ellipsis"><%= user_icon %><%= link_to_user_if_accessible(project.creator, nil) %></div>
                  </div>
                </div>
                
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

    </div>

  </div>

  <div class="section footer">
    <p class="section-title">For Development:</p>
    <div class="py-4 d-flex justify-center"><%= link_to 'Reboot Manager', reboot_path, { :class => "btn-solid-primary" } %></div>
  </div>
</div>

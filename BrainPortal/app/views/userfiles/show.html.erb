
<% title "File Info" %>

<h2>File details for <%= h @userfile.name %></h2>

<div class="generalbox">

  <table class="resource_list edit_file_table">
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Name:</th>
      <td colspan="2"><%= h @userfile.name %></td>
    </tr class="list-odd">
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Owner:</th>
      <td><%= link_to_user_if_accessible(@userfile.user) %></td>
      <td></td>
    </tr>
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Size:</th>
      <td><%= h(@userfile.format_size) %></td>
      <td><% if @userfile.size && @userfile.size >= 1_000 -%>
          = <%= @userfile.size %> bytes
          <% end -%>
      </td>
    </tr>  

    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Parent:</th>
      <td><%= link_to_userfile_if_accessible(@userfile.parent) %></td>
      <td></td>
    </tr>

    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Children:</th>
      <td><%= @userfile.children.sort {|a,b| a.name.casecmp(b.name)}.map {|u| link_to_userfile_if_accessible(u)}.join("<br>") %></td>
      <td></td>
    </tr>
 
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Created at:</th>
      <td><%=h(to_localtime(@userfile.created_at,:datetime)) %></td>
      <td>(<%= pretty_elapsed(Time.now - @userfile.created_at) %> ago)</td>
    </tr>

    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Modified at:</th>
      <td><%=h(to_localtime(@userfile.updated_at,:datetime)) %></td>
      <td>(<%= pretty_elapsed(Time.now - @userfile.updated_at) %> ago)</td>
    </tr>
 
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Project:</th>
      <td><%= link_to_group_if_accessible(@userfile.group) %></td>
      <td></td>
    </tr>
    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Project permission on file:</th>
      <td><%= h @userfile.group_writable? ? "Read/Write" : "Read" %></td>
      <td></td>
    </tr>

    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Data Provider:</th>
      <td><%= link_to_data_provider_if_accessible(@userfile.data_provider) %>
      ( <%= h(@userfile.data_provider.class.to_s) %> )
      </td>
      <td>
          <% @userfile.sync_status.each do |syncstat| %>
            <%= render :partial => 'syncstatus', :locals => { :syncstat => syncstat } %>
          <% end %>
      </td>
    </tr>

    <% if current_user.has_role? :admin %>
      <tr class="<%= cycle('list-odd', 'list-even') %>">
        <th class="right_align">Local Data Provider (cache) path:</th>
        <td colspan="2"><%= h(@userfile.cache_full_path) %></td>
      </tr>
      <% if @userfile.data_provider.respond_to?(:provider_full_path) %>
        <tr class="<%= cycle('list-odd', 'list-even') %>">
          <th class="right_align">Remote SSH Data Provider path:</th>
          <td colspan="2"><%= h(@userfile.data_provider.provider_full_path(@userfile)) %></td>
        </tr>
      <% end %>
    <% end %>

    <tr class="<%= cycle('list-odd', 'list-even') %>">
      <th class="right_align">Tags:</th>
      <td colspan="2">
        <%= @userfile.tags.map(&:name).join(", ") %>
      </td>
    </tr>
  </table>
  
  <P>

  <% if @userfile.can_be_accessed_by?(current_user) %>
    <% unless @userfile.is_locally_synced? %>

      <P>

      <% if @sync_status =~ /^To/ %>
        <% if @userfile.is_a?(FileCollection) %>
          <p>This Collection is currently being synchronized.</p>
        <% else %>
          <p>This file is currently being synchronized.</p>
        <% end %>
      <% elsif ! (@userfile.data_provider.not_syncable?) %>
        <% if @userfile.is_a?(FileCollection) %>
          <p>This Collection is not currently synchronized.<BR>
        <% else %>
          <p>This file is not currently synchronized.<BR>
        <% end %>
        Click <%= link_to "here", sync_to_cache_userfile_path(@userfile), :method  => :post %>
        to start the synchronization process.<br>
        Synchronizing to the local cache will allow you to view displayable contents<% if @userfile.is_a?(FileCollection) %> and extract files from this collection<% end %>.
        </p>
      <% end %>
    <% end %>
  
    <%= link_to "Edit File", edit_userfile_path(@userfile), :class  => "action_link" %>
  <% end %>
  
  
  <% if @userfile.is_a?(CivetCollection) || @userfile.is_a?(CivetStudy) %>
      <br><br>
      <%= overlay_ajax_link "Civet Directories Decrypted", "/doc/userfiles/civet_directories.html" %>
      <br>
  <% end %>
  <P>
   
  <% if @userfile.is_locally_synced? %>
    <%= display_contents(@userfile) %>
    <% if @userfile.is_a?(CivetStudy) && @userfile.list_files(".", :directory).find{ |dir| dir.name[-3, 3] == "/QC" }%>
      <%= overlay_ajax_link "Civet QC Legend", "/doc/userfiles/civetqc_results.html" %>
      
        <div id="userfile_contents_display" class="loading_message">
        
          <strong>QC</strong><br><br>
          <% ajax_element(url_for(:action  => :content, :qc_file  => "base")) do %>
            <span class="loading_message">Loading...</span>
          <% end %>
          <br>
          <div id="qc_data">
          </div>
        </div>
    <% end %>
  <% end %>

  <P>

  <% if @userfile.is_a?(FileCollection) %>
    <% ajax_element(content_userfile_path(@userfile), :class  => "loading_message") do %>
      <br>
      Loading...
      <br>
    <% end %>
  <% end %>

  <P>

  <%= render :partial => "layouts/log_report", :locals  => { :log  => @log, :title => 'File Log' } %>

</div>


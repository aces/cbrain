<div class="active_filters">
  <% unless @filter_params["filter_hash"].blank? && @filter_params["filter_tags_array"].blank? && @filter_params["filter_custom_filters_array"].blank? %>  
     Active Filters (<%= filter_clear_link 'clear', :class  => "action_link" %>):  
      <span id="current_filters">
        <% 
          filters = @filter_params["filter_hash"].map do |att, val| 
            "<span class=\"current_filters_item\">#{crop_text_to(30, display_filter(:userfiles, att, val, {:user  => :login}))}</span>" + filter_remove_link(delete_icon, att)
          end 
          filters += current_user.available_tags.find(@filter_params["filter_tags_array"]).map do |tag|
            "<span class=\"current_filters_item\">#{crop_text_to(30, "Tag: #{tag.name}")}</span>" + filter_remove_link(delete_icon, tag.id, :parameter  => :filter_tags_array)
          end
          filters += current_user.custom_filters.find(@filter_params["filter_custom_filters_array"]).map do |filter|
            "<span class=\"current_filters_item\">#{crop_text_to(30, "Custom: #{filter.name}")}</span>" + filter_remove_link(delete_icon, filter.id, :parameter  => :filter_custom_filters_array)
          end
        %>
        <%= filters.join(", ").html_safe %>
      </span>
  <% end %>
</div>
<div class="pagination">
  <%= render :partial => 'userfiles/pagination' %>
</div>


<%= index_table @userfiles, :class => "resource_list", :id => "userfiles_table" do |t| %>
  <%
    t.row_attributes do |u|
      if params[:find_file_id].to_s == u.id.to_s
        { :class => "selected_row row_highlight" }
      elsif u.available?
        { :class =>"#{cycle("list-odd", "list-even")} row_highlight" }
      else
        { :class => "row_highlight", :title => "This file is unavailable due to its provider being offline" }
      end
    end
    t.column(select_all_checkbox("userfiles_checkbox")) do |u|
      check_box_tag("file_ids[]", u.id.to_s, current_session.persistent_userfile_ids[u.id.to_s], :class  => 'userfiles_checkbox', :disabled => !u.available?)
    end
    t.describe_sort_column("Filename", 'Userfile', 'name') do |col|
      col.cell(:class => "left") { |u| filename_listing(u, :html_options => { :class => !u.available? ? 'error_link' : nil } ) }
    end
    t.sort_column("Type", 'Userfile', 'type', :filters => basic_filters_for(@header_scope, Userfile, :type)) { |u| u.pretty_type }
  %>
  <% unless @filter_params["details"] == 'off' %>
    <% t.sort_column("Owner", 'User', 'login', :filters => association_filters_for(@header_scope, Userfile, :user, :name_method => "login")) { |u| link_to_user_if_accessible(u.user) } %>
    <% t.sort_column("Creation Date", 'Userfile', 'created_at') do |u| %>
     <%=  html_tool_tip(to_localtime(u.created_at,:date), :offset_x => 0, :offset_y => 20) do %>
          Created: <%= u.created_at.in_time_zone.strftime("%a %b %d, %Y at %H:%M:%S %Z") %><br/>
          Updated: <%= u.updated_at.in_time_zone.strftime("%a %b %d, %Y at %H:%M:%S %Z") %>
     <% end %>
    <% end %>
  <% end %>
  <% t.sort_column("Size", 'Userfile', 'size') do |u| %>
    <% if u.size != nil %>
      <span title="<%= u.size %> bytes"><%= u.format_size %></span>
    <% else %>
      <font color="red">unknown</font>"
    <% end %>
  <% end %>
  <% t.column("Tags", :filters => @tag_filters) { |u| u.get_tags_for_user(current_user).collect{ |t| h(t.name) }.join("<br>").html_safe } %>
  <% 
    unless current_project
       t.describe_sort_column("Project", 'Group', 'name', :filters => association_filters_for(@header_scope, Userfile, :group)) do |col|
         col.cell(:if => Proc.new { |u| u.group } ) { |u| link_to_group_if_accessible(u.group) }
       end
     end
     t.describe_sort_column("Project Access", 'Userfile', 'group_writable') do |col|
       col.cell(:if => Proc.new { |u| u.group } ) { |u| u.group_writable ? 'Read/Write' : 'Read Only' }
     end
     unless @filter_params["details"] == 'off'
       t.sort_column("Provider", 'DataProvider', 'name', :filters => association_filters_for(@header_scope, Userfile, :data_provider)) { |u| link_to_data_provider_if_accessible(u.data_provider) }
     end
  %>
<% end %>


